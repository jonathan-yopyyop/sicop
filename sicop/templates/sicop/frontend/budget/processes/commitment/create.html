{% extends 'sicop/frontend/base/base.html' %}

{% load static %}
{% load i18n %}
{% load humanize %}
{% block page_title %}
  {% trans 'Budget commitment create' %}
{% endblock page_title %}
{% block content %}
  <style>
    .label-project{
      font-size: 10px;
    }
    .blank-label{
      font-size: 10px;
      color: white;
    }
  </style>
  <section id="configuration">
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h4 class="card-title">{% trans 'Budget Commitment' %}</h4>
            <a class="heading-elements-toggle"><i class="fa fa-ellipsis-v font-medium-3"></i></a>
            <div class="heading-elements">
              <ul class="list-inline mb-0">
                <li>
                  <a href="{% url 'budget_redistribution_list' %}">
                    <button type="button" class="btn btn-icon btn-success mr-1 mb-1">
                      <i class="fa fa-list"></i>
                    </button>
                  </a>
                </li>
              </ul>
            </div>
          </div>
          <div class="card-content collapse show">
            <div class="card-body card-dashboard">
              <section id="basic-form-layouts">
                <div class="row match-height">
                  <div class="col-md-12">
                    <div class="card">
                      {% if messages %}
                        {% for message in messages %}
                          <div class="alert alert-{{ message.tags }} alert-dismissible mb-2"
                               role="alert">
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                              <span aria-hidden="true">Ã—</span>
                            </button>
                            {{ message }}
                          </div>
                        {% endfor %}
                      {% endif %}
                      <div class="form-body">
                        <div class="row">
                          <div class="col-md-12">
                            <div class="form-group">
                              <div class="row">
                                <div class="col-12">
                                  <h4 class="form-section">
                                    {% trans "Commitment Information" %}
                                    <input type="hidden" name="commitment_id" id="commitment_id" value="{{commitment.id}}">
                                  </h4>
                                  <div class="row">
                                    <div class="col-10">
                                      <label class="label-project" for="caps">{% trans 'CAPs' %}</label>
                                      <select class="form-control" id="caps">
                                        {% if commitment.provision_cart is None %}
                                        <option value="">{% trans "Search and select a CAP" %}</option>
                                        {% else %}
                                          <option value="{{commitment.provision_cart.id}}">{{commitment.provision_cart}}</option>
                                        {% endif %}
                                      </select>
                                    </div>
                                    <div class="col-2">
                                      <label class="label-project" for="has_tax">{% trans 'Has tax?' %}</label>
                                      <select class="form-control select2" id="has_tax" disabled>
                                        <option value="yes" {% if commitment.has_tax %} selected {% endif %}>{% trans "Yes" %}</option>
                                        <option value="yes" {% if not commitment.has_tax %} selected {% endif %}>{% trans "No" %}</option>
                                      </select>
                                    </div>
                                    <div class="col-12">
                                      <label class="label-project" for="contract">{% trans 'Contracts or PO' %}</label>
                                      <div class="row">
                                        <div class="col-4">
                                          <select class="form-control select2" id="type">
                                            <option value="">{% trans "Select a type" %}</option>
                                            {% for commitment_type in commitment_types %}
                                              <option value="{{ commitment_type.0 }}" {% if commitment_type.0 == commitment.contract_or_po %} selected {% endif %}>{{ commitment_type.1 }}</option>
                                            {% endfor %}
                                          </select>
                                        </div>
                                        <div class="col-8">
                                          <div class="row">
                                            <div class="col-12">
                                              <div id="contract_div" class="entity_id" {% if commitment.contract_or_po == 'PO' %} style="display: none; width: 100%;" {% endif %}>
                                                <select class="form-control" id="contract" style="width: 100%;">
                                                  {% if commitment_contract is None %}
                                                  <option value="">{% trans "Search and select a contract" %}</option>
                                                  {% else %}
                                                  <option value="{{commitment_contract.id}}">{% trans "Contract" %} {{commitment_contract.contract}} {% trans "Third" %} {{commitment_contract.contract.IdTercer}}</option>  
                                                  {% endif %}
                                                </select>
                                              </div>
                                            </div>
                                            <div class="col-12">
                                              <div id="po_div" class="entity_id" {% if commitment.contract_or_po == 'CT' %} style="display: none; width: 100%;" {% endif %}>
                                                <select class="form-control" id="po" style="width: 100%;">
                                                  {% if commitment_po is None  %}
                                                  <option value="">{% trans "Search and select a PO" %}</option>  
                                                  {% else %}
                                                  <option value="{{commitment_po.id}}">{% trans "PO" %} {{commitment_po}} {% trans "Third" %} {{commitment_po.po.IdTercer}}</option>
                                                  {% endif %}
                                                </select>
                                              </div>
                                            </div>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                    <div class="col-12">
                                      <label class="label-project" for="caps">{% trans 'Thirds' %}</label>
                                      <select class="form-control" id="thirds">
                                        {% if commitment.third is None %}
                                        <option value="">{% trans "Search and select a third" %}</option>  
                                        {% else %}
                                        <option value="{{commitment.third.id}}">{{commitment.third}}</option>
                                        {% endif %}
                                      </select>
                                    </div>
                                  </div>
                                </div>
                              </div>
                              <div class="mt-2">
                                <hr>
                              </div>
                              <div class="row">
                                <div class="col-12">
                                  <h4 class="form-section">
                                    {% trans "Commitment verification" %}
                                  </h4>
                                  <div class="row">
                                    <div class="col-4">
                                      <label class="label-project" for="cap_budget">{% trans 'CAP budget' %}</label>
                                      <input type="text" name="cap_budget" id="cap_budget" class="form-control form-control-sm" value="${{commitment.provision_budget_amount | intcomma}}" disabled>
                                    </div>
                                    <div class="col-4">
                                      {% if commitment.contract_or_po == 'CT' %}
                                      <label class="label-project" for="required">{% trans 'Contract budget' %}</label>
                                      {% else %}
                                      <label class="label-project" for="required">{% trans 'PO budget' %}</label>
                                      {% endif %}
                                      <input type="text" id="required" class="form-control form-control-sm" value="${{commitment.required_amount | intcomma}}" disabled>
                                    </div>
                                    <div class="col-4">
                                      {% if commitment.contract_or_po == 'CT' %}
                                      <label class="label-project" for="required">{% trans 'Difference between CAP and Contract budget' %}</label>
                                      {% else %}
                                      <label class="label-project" for="required">{% trans 'Difference between CAP and PO budget' %}</label>
                                      {% endif %}
                                      <input type="text" name="difference" id="difference" class="form-control form-control-sm" value="${{commitment.diference_between_required_and_provisioned | intcomma}}" disabled>
                                    </div>
                                  </div>
                                </div>
                              </div>
                              <div class="mt-2">
                                <hr>
                              </div>
                              <div class="row" id="realease_div" {% if commitment.diference_between_required_and_provisioned <= 0 %} style="display: none;" {% endif %}>
                                <div class="col-12">
                                  <h4 class="form-section">
                                    {% trans "Release resources" %}
                                  </h4>
                                  <div class="row">
                                    <div class="col-4">
                                      <label class="label-project" for="required">{% trans 'Total for release' %}</label>
                                      <input type="text" class="form-control form-control-sm" name="to_release_text" id="to_release_text" value="${{commitment_release.total_to_release | intcomma}}" readonly>
                                    </div>
                                    <div class="col-4">
                                      <label class="label-project" for="released_text">{% trans 'Total released' %}</label>
                                      <input type="text" class="form-control form-control-sm" name="released_text" id="released_text" value="${{commitment_release.total_released | intcomma}}" readonly>
                                    </div>
                                    <div class="col-4">
                                      <label class="label-project" for="total_pending_text">{% trans 'Pending for release' %}</label>
                                      <input type="text" class="form-control form-control-sm" name="total_pending_text" id="total_pending_text" value="${{commitment_release.total_pending | intcomma}}" readonly>
                                    </div>
                                    <div class="col-12 mt-2">
                                      <table class="table" id="items_table">
                                        <thead>
                                            <tr>
                                                <th>{% trans 'Item' %}</th>
                                                <th>{% trans 'Amount to release' %}</th>
                                            </tr>
                                        </thead>
                                        <tbody id="items_table_body">
                                          
                                          {% for commitment_release_item in commitment_release.commitment_release_items.all %}
                                            
                                            <tr id="row_{{commitment_release_item.id}}">
                                              <td>
                                                {{commitment_release_item.budget.budget_description}}
                                              </td>
                                              <td>
                                                <input 
                                                  type="text" id="releaseded_{{commitment_release_item.id}}" 
                                                  class="form-control form-control-sm table_item_class" 
                                                  value ="{{commitment_release_item.total_to_release}}" 
                                                  onkeyup="releasingValues('{{commitment_release_item.id}}')"/>
                                              </td>
                                            </tr>  
                                          {% endfor %}
                                        </tbody>
                                      </table>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <form method="post">
                        {% csrf_token %}
                        <div class="col-md-12">
                          <div class="form-group row">
                            <div class="col-12">
                              <label class="col-md-12 label-control required" for="projectinput4">{% trans "Observation" %}</label>
                              <textarea class="form-control form-control-sm" name="observation" id="" cols="30" rows="5"></textarea>
                            </div>
                          </div>
                          <div class="form-actions text-right">
                            <input type="hidden" name="commitment_object_id" id="commitment_object_id" value="{{commitment_id.id}}">
                            <button type="submit" class="btn btn-primary" id="create_button" {% if commitment.diference_between_required_and_provisioned < 0 %} disabled{% endif %}>
                              <i class="fa fa-edit"></i> {% trans 'Create' %}
                            </button>
                          </div>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </section>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"
          integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
          crossorigin="anonymous"></script>
  <script>
    // Function to for releasing
    function releasingValues(id){
        var released_value = $("#releaseded_"+id).val();
        console.log(released_value);
        var url = "{% url 'commitment_release_update' %}";
        var post_values = {
          'commiment_release_item_id': id,
          'commitment_release_amount': released_value,
        };
        $.ajax({
          url: url,
          method: "POST",
          type: "json",
          beforeSend: function (xhr, settings) {
            xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
          },
          data: post_values,
          success: function(data) {
            if (data.status == "ok") {
              var total_to_release= data.total_to_release;
              var total_released = data.total_released;
              var total_pending = data.total_pending;
              var formated_total_to_release = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
              }).format(total_to_release);
              var formated_total_released = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
              }).format(total_released);
              var formated_total_pending = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
              }).format(total_pending);
              console.log(`formated_total_pending: ${formated_total_pending}`);
              console.log(`formated_total_released: ${formated_total_released}`);
              console.log(`formated_total_to_release: ${formated_total_to_release}`);
              $("#total_pending_text").val(formated_total_pending);
              $("#released_text").val(formated_total_released);
              $("#to_release_text").val(formated_total_to_release);
            }
            else{
              console.log(data);
              console.log("Item not updated");
            }
          }
        });

      }
    $(document).ready(function() {
      // Fution to update resume values
      function updateResumeValues(provision_budget_amount, required_amount, diference_between_required_and_provisioned){
        console.log(diference_between_required_and_provisioned);
        // print diference_between_required_and_provisioned type
        console.log(typeof(diference_between_required_and_provisioned));
        if(diference_between_required_and_provisioned > 0){
          console.log("show");
          $("#realease_div").show();
          Swal.fire({
            title: "{% trans 'Alert' %}",
            text: "{% trans 'The value of the CAP is higher, a budget release is required.' %}",
            type: "warning",
            confirmButtonText: "{% trans 'Ok' %}"
          });
        }else{
          $("#realease_div").hide();
          Swal.fire({
            title: "{% trans 'Error' %}",
            text: "{% trans 'The value of the project or PO is greater than the CAP, please verify' %}",
            type: "error",
            confirmButtonText: "{% trans 'Ok' %}"
          });
          $("#create_button").prop('disabled', true);
        }
        var formated_provision_budget_amount = new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
        }).format(provision_budget_amount);
        var formated_required_amount = new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
        }).format(required_amount);
        var formated_diference_between_required_and_provisioned = new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
        }).format(diference_between_required_and_provisioned);
        $("#cap_budget").val(formated_provision_budget_amount);
        $("#required").val(formated_required_amount);
        $("#difference").val(formated_diference_between_required_and_provisioned);
        $("#to_release_text").val(formated_diference_between_required_and_provisioned);
        $("#to_release").val(diference_between_required_and_provisioned);
      }
      // select2 search
      $('#caps').select2({
        language: "es",
        minimumInputLength: 1,
        ajax: {
            url: "{% url 'get_provision_carts_by_criteria' %}",
            dataType: 'json',
            delay: 250,
            processResults: function(data) {
              return {
                  results: data
              };
            },
            cache: true
        }
      });
      $('#contract').select2({
        language: "es",
        minimumInputLength: 4,
        ajax: {
            url: "{% url 'contract_list_search_criteria' %}",
            dataType: 'json',
            delay: 250,
            processResults: function(data) {
              return {
                  results: data
              };
            },
            cache: true
        }
      });
      $('#po').select2({
        language: "es",
        minimumInputLength: 4,
        ajax: {
            url: "{% url 'purchase_order_list_search_criteria' %}",
            dataType: 'json',
            delay: 250,
            processResults: function(data) {
              return {
                  results: data
              };
            },
            cache: true
        }
      });
      $('#type').on('change', function() {
        var type = $(this).val();
        if (type == 'CT') {
          $('#contract_div').show();
          $('#po_div').hide();
        } else if (type == 'PO') {
          $('#contract_div').hide();
          $('#po_div').show();
        } else {
          // hide po and contract
          $('#contract_div').hide();
          $('#po_div').hide();
        }
      });
      $('#thirds').select2({
          language: "es",
          minimumInputLength: 4,
          ajax: {
              url: "{% url 'third_list_search_criteria' %}",
              dataType: 'json',
              delay: 250,
              processResults: function(data) {
                return {
                    results: data
                };
              },
              cache: true
          }
        });
      //Update CAP on commitment
      $('#caps').on("change", function(){
        var commitment_id = $('#commitment_id').val();
        var cap_id = $(this).val();
        var url = "{% url 'update_commitment_cap' %}";
        var post_values = {
          'commitment_id': commitment_id,
          'cap_id':cap_id,
        };
        $.ajax({
          url: url,
          method: "POST",
          type: "json",
          beforeSend: function (xhr, settings) {
            xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
          },
          data: post_values,
          success: function(data) {
            if (data.status == 'ok') {
              var has_tax = data.has_tax;
              var total_provisioned_amount = data.total_provisioned_amount;
              var formated_total_provisioned_amount = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
              }).format(total_provisioned_amount);
              $("#cap_budget").val(formated_total_provisioned_amount);
              var yes_text = "{% trans 'Yes' %}"
              var no_text = "{% trans 'No' %}"
              // clean has_tax options
              $('#has_tax').empty();
              // change selected option on has_tax based on has_tax value
              if(has_tax){
                $("#has_tax").append(`<option value="yes" selected>${yes_text}</option>`);
                $("#has_tax").append(`<option value="no">${no_text}</option>`);
              }else{
                $("#has_tax").append(`<option value="yes">${yes_text}</option>`);
                $("#has_tax").append(`<option value="no" selected>${no_text}</option>`);
              }
              // Resume values
              console.log(data);
              var provision_budget_amount = data.provision_budget_amount;
              var required_amount = data.required_amount;
              var diference_between_required_and_provisioned = data.diference_between_required_and_provisioned;
              updateResumeValues(total_provisioned_amount, required_amount, diference_between_required_and_provisioned);
              // Populate release table
              if(diference_between_required_and_provisioned > 0){
                console.log("show");
                $("#realease_div").show();
                var commitment_release_dict = data.commitment_release_dict;
                var commitment_release_items = commitment_release_dict.commitment_release_items;
                // clear the elements inside the table body with id items_table_body
                $("#items_table_body").empty();
                // create a loop using jquery map over commitment_release_items
                commitment_release_items.forEach(function(item, j) {  
                  console.log(item);
                
                  var commitment_release_item = item;
                  var budget_description = commitment_release_item.budget_description;
                  var total_to_release = commitment_release_item.total_to_release;
                  var id = commitment_release_item.id;
                  console.log(`id: ${id}`);
                  var row = `
                  <tr id="row_${id}">
                    <td>
                      ${budget_description}
                    </td>
                    <td>
                      <input 
                        type="text" id="releaseded_${id}" 
                        class="form-control form-control-sm table_item_class" 
                        value ="${total_to_release}" 
                        onkeyup="releasingValues('${id}')"/>
                    </td>
                  </tr>`;
                  $("#items_table_body").append(row);
                });
              }
            } else {
              console.log("Error");
              console.log(data);
            }
          }
        });
      });
      //Update contract or po on commitment
      $('#type').on("change", function(){
        var commitment_id = $('#commitment_id').val();
        var type = $(this).val();
        var url = "{% url 'update_contract_or_po_cap' %}";
        var post_values = {
          'commitment_id': commitment_id,
          'type':type,
        };
        $.ajax({
          url: url,
          method: "POST",
          type: "json",
          beforeSend: function (xhr, settings) {
            xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
          },
          data: post_values,
          success: function(data) {
            if (data.status == 'ok') {
              console.log(data);
            } else {
              console.log("Error");
              console.log(data);
            }
          }
        });
      });
      //Update third on commitment
      $('#thirds').on("change", function(){
        var commitment_id = $('#commitment_id').val();
        var third_id = $(this).val();
        var url = "{% url 'update_third_cap' %}";
        var post_values = {
          'commitment_id': commitment_id,
          'third_id':third_id,
        };
        $.ajax({
          url: url,
          method: "POST",
          type: "json",
          beforeSend: function (xhr, settings) {
            xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
          },
          data: post_values,
          success: function(data) {
            if (data.status == 'ok') {
              console.log("Ok");
              console.log(data);
            } else {
              console.log(data);
            }
          }
        });
      });
      //Update contract or po entity on commitment
      $('.entity_id').on("change", function(){
        var commitment_id = $('#commitment_id').val();
        var entity_id = $(this).val();
        var contract_or_po = $('#type').val();
        if (contract_or_po == 'CT') {
          entity_id = $("#contract").val();
        } else if (contract_or_po == 'PO') {
          entity_id = $("#po").val();
        }
        var url = "{% url 'update_contract_or_po_cap_entity' %}";
        var post_values = {
          'commitment_id': commitment_id,
          'entity_id':entity_id,
          'contract_or_po':contract_or_po,
        };
        $.ajax({
          url: url,
          method: "POST",
          type: "json",
          beforeSend: function (xhr, settings) {
            xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
          },
          data: post_values,
          success: function(data) {
            if (data.status == 'ok') {
              console.log("Ok");
              var provision_budget_amount = data.provision_budget_amount;
              var required_amount = data.required_amount;
              var diference_between_required_and_provisioned = data.diference_between_required_and_provisioned;
              updateResumeValues(total_provisioned_amount, required_amount, diference_between_required_and_provisioned);
            } else {
              console.log("Error");
              console.log(data);
            }
          }
        });
      });
    });
</script>
{% endblock content %}
